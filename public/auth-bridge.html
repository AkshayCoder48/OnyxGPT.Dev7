<!DOCTYPE html>
<html>
<head>
    <title>Puter Auth Bridge</title>
</head>
<body>
    <div id="status" style="font-family: sans-serif; text-align: center; margin-top: 50px;">
        <p>Connecting to Puter...</p>
    </div>
    <script src="https://js.puter.com/v2/"></script>
    <script>
        const channel = new BroadcastChannel('puter_auth');
        const statusDiv = document.getElementById('status');

        async function handleSignIn() {
            if (typeof puter === 'undefined') {
                console.error("Puter script not loaded yet");
                statusDiv.innerHTML = '<p style="color: orange;">Initializing Puter SDK...</p>';
                setTimeout(handleSignIn, 500);
                return;
            }

            try {
                const isSignedIn = await puter.auth.isSignedIn();
                if (isSignedIn) {
                    statusDiv.innerHTML = '<p style="color: green;">Authenticated! Transferring session...</p>';
                    const token = await puter.auth.getAuthToken();
                    channel.postMessage({ type: 'AUTH_SUCCESS', token: token });
                    setTimeout(() => window.close(), 1000);
                } else {
                    statusDiv.innerHTML = '<p>Opening sign-in popup...</p>';
                    await puter.auth.signIn();

                    // After sign-in, check again
                    const signedInNow = await puter.auth.isSignedIn();
                    if (signedInNow) {
                        const token = await puter.auth.getAuthToken();
                        channel.postMessage({ type: 'AUTH_SUCCESS', token: token });
                        statusDiv.innerHTML = '<p style="color: green;">Success! Closing window...</p>';
                        setTimeout(() => window.close(), 1000);
                    }
                }
            } catch (err) {
                console.error("Auth Bridge Error:", err);
                statusDiv.innerHTML = '<p style="color: red;">Error: ' + err.message + '</p>';
                channel.postMessage({ type: 'AUTH_ERROR', error: err.message });
            }
        }

        // Wait for window load to ensure all scripts are executed
        window.onload = handleSignIn;
    </script>
</body>
</html>
