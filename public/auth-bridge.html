<!DOCTYPE html>
<html>
<head>
    <title>Puter Auth Bridge</title>
</head>
<body>
    <div id="status" style="font-family: sans-serif; text-align: center; margin-top: 50px;">
        <p>Authenticating with Puter...</p>
    </div>
    <script src="https://js.puter.com"></script>
    <script>
        const channel = new BroadcastChannel('puter_auth');
        const statusDiv = document.getElementById('status');

        async function handleSignIn() {
            try {
                const isSignedIn = await puter.auth.isSignedIn();
                if (isSignedIn) {
                    statusDiv.innerHTML = '<p style="color: green;">Authenticated! Transferring session...</p>';
                    const token = await puter.auth.getAuthToken();
                    channel.postMessage({ type: 'AUTH_SUCCESS', token: token });

                    // Also try the suggested 'getToken' if getAuthToken is null
                    if (!token) {
                        const tokenFallback = puter.auth.getToken ? puter.auth.getToken() : null;
                        if (tokenFallback) {
                            channel.postMessage({ type: 'AUTH_SUCCESS', token: tokenFallback });
                        }
                    }

                    setTimeout(() => window.close(), 1000);
                } else {
                    // This might redirect the page
                    await puter.auth.signIn();

                    // If it returned from redirect and we are here, check again
                    const signedInNow = await puter.auth.isSignedIn();
                    if (signedInNow) {
                        const token = await puter.auth.getAuthToken();
                        channel.postMessage({ type: 'AUTH_SUCCESS', token: token });
                        setTimeout(() => window.close(), 1000);
                    }
                }
            } catch (err) {
                console.error("Auth Bridge Error:", err);
                statusDiv.innerHTML = '<p style="color: red;">Error: ' + err.message + '</p>';
                channel.postMessage({ type: 'AUTH_ERROR', error: err.message });
            }
        }

        handleSignIn();
    </script>
</body>
</html>
